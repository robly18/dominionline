<html>
<head>

<script>
function makeAction(a) {
	return JSON.stringify([playerno, a]);
}
function startAction() {
	return {tag:"StartGame"};
}
function sayAction(c) {
	return {tag:"Say", contents:c};
}


function pollAction() {
	return {tag:"Poll"};
}


function playCardAction(c) {
	return {tag:"Play", contents:c};
}
function nextPlayerAction() {
	return {tag:"EndTurn"};
}

function ajax(url, data, callback) {
  var xhttp;
  xhttp=new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      callback(this);
    }
  };
  xhttp.open("POST", url, true);
  xhttp.send(data);
}

function sendAction(a) {
    return ajax('/send/', makeAction(a), render);
}

function render(data) {
	let logstate = JSON.parse(data.responseText);
	let log = logstate[0];
	let state = logstate[1];
	renderLog(log);
	document.getElementById("state").innerHTML = data.responseText;
	console.log(data.responseText);
}

function renderLog(log) {
	let logdiv = document.getElementById("log");

	let isScrolledToBottom = logdiv.scrollHeight - logdiv.clientHeight <= logdiv.scrollTop + 1;
	//in the event i add a scrollbar later.

	clearNode(logdiv);
	for (let msg of log) {
		let t = document.createTextNode(msg);
		logdiv.appendChild(t);
		logdiv.appendChild(document.createElement("br"));
	}

	if(isScrolledToBottom)
		logdiv.scrollTop = logdiv.scrollHeight - logdiv.clientHeight;
}


let playerno = null;

function getPlayer(data) {
	playerno = JSON.parse(data.responseText);
}


function hide(name) {document.getElementById(name).style.display = "none"}
function show(name) {document.getElementById(name).style.display = "block"}
function clearNode(n) {
	while (n.childNodes.length != 0) n.removeChild(n.childNodes[0]);
}

function getTextboxData() {
    let txtbox = document.getElementById("text");
    let txt = txtbox.value;
    txtbox.value = "";
    return txt;
}

function sendText() {
    return sendAction(sayAction(getTextboxData()));
}

function playCard() {
    return sendAction(playCardAction(parseInt(getTextboxData(), 10)));
}

function nextPlayer() {
    return sendAction(nextPlayerAction());
}
</script>
</head>
<body>
<h1>Hello world.</h1>

<br>

<button type="button"
id="join"
onclick="ajax('/join/', '', getPlayer)">Join
</button>
<button type="button"
id="start"
onclick="sendAction(startAction())">Start
</button>

<br>

<button type="button"
id="send"
onclick="sendText()">Send
</button>

<button type="button"
onclick="playCard()">Play
</button>

<button type="button"
onclick="nextPlayer()">End turn
</button>

<input type="text" id="text"> </input>

<div
id="log"
style="height:15em; border-style:solid; overflow-y:scroll;"
>
</div>

<div id="state"
style="height:5em; border-style:solid; overflow:auto;"
>

<script>
document.getElementById("text").onkeypress = function(k){if (k.keyCode==13) sendText();};

ajax('/send/', pollAction(), render);
window.setInterval(function(){sendAction(pollAction())}, 1000)</script>
</body>
</html>
