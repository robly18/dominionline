<html>
<head>

<script>
function makeAction(a) {
	return JSON.stringify([playerno, a]);
}
function startAction() {
	return {tag:"StartGame"};
}
function sayAction(c) {
	return {tag:"Say", contents:c};
}


function pollAction() {
	return {tag:"Poll"};
}


function playCardAction(c) {
	return {tag:"Play", contents:c};
}
function nextPlayerAction() {
	return {tag:"EndTurn"};
}
function buyCardAction(i) {
    return {tag:"Buy", contents:i};
}
function choiceAction(c) {
	return {tag:"Choose", contents:c};
}
function cremodel(i, j) {
	return {tag:"CRemodel", contents:[i,j]};
}
function skipchoice() {
	return {tag:"SkipChoice"};
}

function ajax(url, data, callback) {
  var xhttp;
  xhttp=new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      callback(this);
    }
  };
  xhttp.open("POST", url, true);
  xhttp.send(data);
}

function sendAction(a) {
    return ajax('/send/', makeAction(a), d => render(d.responseText));
}

function render(data, force_render) {
	console.log(data);
	if (data.responseText == previousStateString && !force_render)
		return;
	previousStateString = data;
	let logstate = JSON.parse(data);
	let log = logstate[1];
	let state = logstate[0];
	document.getElementById("state").innerHTML = JSON.stringify(state);
	console.log(state);
	renderLog(log);
	switch (state.tag) {
	case "GameState":
		if (playerno != null) {
			let p = state.contents._players.list[playerno];
			refreshFlag(p._pendingChoices);
			renderSkipChoiceButton();
			renderHand(p._hand);
			renderDiscard(p._discarded);
			renderPlayed(p._played);
			renderDeck(p._deck);
			renderPlayerData(p, playerno == state.contents._players.index);
		}
		renderOtherPlayerData(state.contents._players.list, state.contents._players.index);
		renderTable(state.contents._table);
		break;
	default: break;
	}
}

function renderLog(log) {
	let logdiv = document.getElementById("log");

	let isScrolledToBottom = logdiv.scrollHeight - logdiv.clientHeight <= logdiv.scrollTop + 1;
	//in the event i add a scrollbar later.

	clearNode(logdiv);
	for (let msg of log) {
		let t = document.createTextNode(msg);
		logdiv.appendChild(t);
		logdiv.appendChild(document.createElement("br"));
	}

	if(isScrolledToBottom)
		logdiv.scrollTop = logdiv.scrollHeight - logdiv.clientHeight;
}

function renderHand(cardSet) {
	let h = document.getElementById("hand");
	clearNode(h);
	for (let [i, c] of cardSet.entries()) {
		let cb = document.createElement("button");
		cb.innerHTML = c;
		cb.onclick = ()=>sendAction(playCardAction(i));
		h.appendChild(cb);
		if (flag && flag.type == "ownCard") {
			let pc = document.createElement("button");
			pc.innerHTML = "X";
			pc.onclick = function() {
				flag = flag.choiceFunc(flag, i);
				this.style.visibility = "hidden";
				render(previousStateString, true);
			}
			h.appendChild(pc);
		}
		h.appendChild(document.createElement("br"));
	}
}
function renderCardSet(elementid, cardSet) {
	let h = document.getElementById(elementid);
	clearNode(h);
	for (let [i, c] of cardSet.entries()) {
		let cb = document.createElement("button");
		cb.innerHTML = c;
		h.appendChild(cb);
		h.appendChild(document.createElement("br"));
	}
}
renderDiscard = d => renderCardSet("discard", d);
renderPlayed = p => renderCardSet("played", p);
renderDeck = d => renderCardSet("deck", d);

function renderTable(table) {
	let h = document.getElementById("table");
	clearNode(h);
	for (let [i, c] of table.entries()) {
		let cb = document.createElement("button");
		cb.innerHTML = c[0] + " (Amt:" + c[1] + ")";
		cb.onclick = ()=>sendAction(buyCardAction(i));
		h.appendChild(cb);
		if (flag && flag.type == "tableCard") {
			let pc = document.createElement("button");
			pc.innerHTML = "X";
			pc.onclick = function() {
				flag = flag.choiceFunc(flag, i);
				this.style.visibility = "hidden";
				render(previousStateString, true);
			}
			h.appendChild(pc);
		}
		h.appendChild(document.createElement("br"));
	}
}

function renderPlayerData(plr, nowPlaying) {
	let dp = document.getElementById("playerdata");
	clearNode(dp);
	dp.appendChild(document.createTextNode("Player " + plr._playerno + (nowPlaying ? " 	(It's your turn!)" : "")));
	dp.appendChild(document.createElement("br"));
	dp.appendChild(document.createTextNode("Money: " + plr._money));
	dp.appendChild(document.createElement("br"));
	dp.appendChild(document.createTextNode("Actions: " + plr._actions));
	dp.appendChild(document.createElement("br"));
	dp.appendChild(document.createTextNode("Purchases: " + plr._purchases));
	dp.appendChild(document.createElement("br"));
}

function renderOtherPlayerData(players, curr) {
	let opddiv = document.getElementById("otherplayers");
	clearNode(opddiv);
	for (let p of players) if (p._playerno != playerno) {
		let newp = document.createElement("p");
		newp.appendChild(document.createTextNode((p._playerno == curr ? "Now playing > " : "") + "Player " + p._playerno + ":"));
		newp.appendChild(document.createElement("br"));
		newp.appendChild(document.createTextNode("Money: " + p._money));
		newp.appendChild(document.createElement("br"));
		newp.appendChild(document.createTextNode("Actions: " + p._actions));
		newp.appendChild(document.createElement("br"));
		newp.appendChild(document.createTextNode("Purchases: " + p._purchases));
		newp.appendChild(document.createElement("br"));
		newp.appendChild(document.createTextNode("Played: " + p._played.join(", ")));
		newp.appendChild(document.createElement("br"));
		newp.appendChild(document.createTextNode("Discard: " + p._discarded.join(", ")));
		newp.appendChild(document.createElement("br"));
		newp.appendChild(document.createTextNode("In deck and hand: " + p._deck.join(", ")));
		newp.appendChild(document.createElement("br"));
		newp.appendChild(document.createTextNode("In hand:" + " ?".repeat(p._hand.length)));
		newp.appendChild(document.createElement("br"));
		opddiv.appendChild(newp);
	}
}


function renderSkipChoiceButton() {
	let scb = document.getElementById("skipChoiceButton");
	if (flag == null) {
		scb.style.display = "none";
	} else {
		scb.style.display = "block";
	}
}

let playerno = null;

let flag = null;
//when it needs to make a choice (or rather, a sequence of choices),
//save something of the sort {type:choiceType, choiceFunc: a function that handles the next}
//choiceFunc works as such: choiceFunc(current_flag, choice) = next_flag
//this setup needs to be reviewed later.
let previousStateString = null;

function refreshFlag(cl) {
	if (cl.length == 0) {flag = null; return;}
	if (flag == null) {
		let c0 = cl[0];
		if (c0 == "CFRemodel") {
			flag = makeRemodelFlag();
		}
	}
}

function makeRemodelFlag() {
	return { type : "ownCard",
			 choiceFunc : function(f, i) {
		return { type : "tableCard",
				 choiceFunc : function(f, j) {
					sendAction(choiceAction(cremodel(i, j)));
					return null;
				}
				}
			}
			}
}


function getPlayer(data) {
	playerno = JSON.parse(data.responseText);
}


function hide(name) {document.getElementById(name).style.display = "none"}
function show(name) {document.getElementById(name).style.display = "block"}
function clearNode(n) {
	while (n.childNodes.length != 0) n.removeChild(n.childNodes[0]);
}

function getTextboxData() {
    let txtbox = document.getElementById("text");
    let txt = txtbox.value;
    txtbox.value = "";
    return txt;
}

function sendText() {
    return sendAction(sayAction(getTextboxData()));
}

function buyCard() {
    return sendAction(buyCardAction(parseInt(getTextboxData(), 10)));
}

function playCard() {
    return sendAction(playCardAction(parseInt(getTextboxData(), 10)));
}

function nextPlayer() {
    return sendAction(nextPlayerAction());
}
</script>
<style>
.hud {
	margin:2ex;
	display:inline-block;
	vertical-align:top;
}
</style>
</head>
<body>
<h1>Hello world.</h1>

<br>

<button type="button"
id="join"
onclick="ajax('/join/', '', getPlayer)">Join
</button>
<button type="button"
id="start"
onclick="sendAction(startAction())">Start
</button>

<br>

<button type="button"
id="send"
onclick="sendText()">Send
</button>

<button type="button"
onclick="buyCard()">Buy
</button>

<button type="button"
onclick="playCard()">Play
</button>

<button type="button"
onclick="nextPlayer()">End turn
</button>

<input type="text" id="text"> </input>

<br>

<button type="button" id="skipChoiceButton"
onclick="sendAction(choiceAction(skipchoice())); render(previousStateString, true);">Skip Choice
</button>

<button type="button" id="skipChoiceButton"
onclick="flag = null; render(previousStateString, true);">Reset Choice
</button>

<div>
	<div id="handdiv" class="hud">
	<p>Hand:</p>
	<div id="hand"></div>
	</div>


	<div id="discarddiv" class="hud">
	<p>Discard:</p>
	<div id="played"></div>
	<br>
	<div id="discard"></div>
	</div>
	<div id="deckdiv" class="hud">
	<p>Deck:</p>
	<div id="deck"></div>
	</div>

	<div id="playerdata" class="hud">
	</div>
</div>

<div id="table"></div>

<div id="otherplayers"></div>

<div
id="log"
style="height:15em; border-style:solid; overflow-y:scroll;"
>
</div>

<div id="state"
style="height:5em; border-style:solid; overflow:auto;"
>

<script>
document.getElementById("text").onkeypress = function(k){if (k.keyCode==13) sendText();};

ajax('/send/', pollAction(), render);
window.setInterval(function(){sendAction(pollAction())}, 1000)</script>
</body>
</html>
