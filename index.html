<html>
<head>

<style>
.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 150px;
  border: solid;
  background-color: white;
  color: black;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;

  position: absolute;
  z-index: 1;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}

.cardButton {
    height: 4ex;
    width: 80%;
}
</style>

<script src="utilities.js"></script>
<script src="cardnode.js"></script>
<script src="render.js"></script>
<script src="renders.js"></script>
<script>

let playerno = -1*0;

let flag = null;
//when it needs to make a choice (or rather, a sequence of choices),
//save something of the sort {type:choiceType, choiceFunc: a function that handles the next}
//choiceFunc works as such: choiceFunc(current_flag, choice) = next_flag
//this setup needs to be reviewed later.
let incompleteData = false; //this flag indicates that, when rendering, something failed and must be rerendered;


function refreshFlag(cl) {
	if (cl.length == 0) {flag = null; return;}
	if (flag == null) {
		let c0 = cl[0];
		switch (c0) {
		case "CFRemodel": flag = makeRemodelFlag(); break;
		case "CFCellar": flag = makeCellarFlag(); break;
		case "CFWorkshop": flag = makeWorkshopFlag(); break;
		case "CFMilitia": flag = makeMilitiaFlag(); break;
		case "CFMine": flag = makeMineFlag(); break;
		}
	}
}

function makeRemodelFlag() {
	return { type : "ownCard",
			 choiceFunc : function(f, i) {
		return { type : "tableCard",
				 choiceFunc : function(f, j) {
					sendAction(choiceAction(cremodel(i, j)));
					return null;
				}
				}
			}
			}
}
function makeCellarFlag() {
	return { type : "ownCard",
			 _cards : [],
			 shortCircuit : function(f) {
				sendAction(choiceAction(ccellar(f._cards)));
				return null;
			 },
			 choiceFunc : function(f, i) {
				f._cards.push(i);
				return f;
			}
			}
}
function makeWorkshopFlag() {
	return { type : "tableCard",
			 choiceFunc : function(f, i) {
				sendAction(choiceAction(cworkshop(i)));
				return null;
			}
			}
}
function makeMilitiaFlag() {
	return { type : "ownCard",
			 _cards : [],
			 shortCircuit : function(f) {
				sendAction(choiceAction(cmilitia(f._cards)));
				return null;
			 },
			 choiceFunc : function(f, i) {
				f._cards.push(i);
				return f;
			}
			}
}
function makeMineFlag() {
	return { type : "ownCard",
			 choiceFunc : function(f, i) {
		return { type : "tableCard",
				 choiceFunc : function(f, j) {
					sendAction(choiceAction(cmine(i, j)));
					return null;
				}
				}
			}
			}
}


function getPlayer(data) {
	playerno = JSON.parse(data.responseText);
}


function hide(name) {document.getElementById(name).style.display = "none"}
function show(name) {document.getElementById(name).style.display = "block"}
function clearNode(n) {
	while (n.childNodes.length != 0) n.removeChild(n.childNodes[0]);
}

function getTextboxData() {
    let txtbox = document.getElementById("text");
    let txt = txtbox.value;
    txtbox.value = "";
    return txt;
}

function sendText() {
    return sendAction(sayAction(getTextboxData()));
}

function buyCard() {
    return sendAction(buyCardAction(parseInt(getTextboxData(), 10)));
}

function playCard() {
    return sendAction(playCardAction(parseInt(getTextboxData(), 10)));
}

function nextPlayer() {
    return sendAction(nextPlayerAction());
}
</script>
<style>
.hud {
	margin:2ex;
	display:inline-block;
	vertical-align:top;
    width: 20%;
}
</style>
</head>
<body>
<h1 id="title">Hello world.</h1>

<div id="scoreboard"></div>

<div id="highlight"></div>

<br>

<button type="button"
id="join"
onclick="ajax('/join/', '', getPlayer)">Join
</button>
<button type="button"
id="start"
onclick="sendAction(startAction())">Start
</button>
<button type="button"
id="start"
onclick="sendAction(nextGameAction())">Next Game
</button>

<br>

<button type="button"
id="send"
onclick="sendText()">Send
</button>

<button type="button"
onclick="buyCard()">Buy
</button>

<button type="button"
onclick="playCard()">Play
</button>

<button type="button"
onclick="nextPlayer()">End turn
</button>

<input type="text" id="text"> </input>

<br>

<button type="button" id="skipChoiceButton"
onclick="sendAction(choiceAction(skipchoice())); renderStateData(previousStateString, true);">Skip Choice
</button>

<button type="button" id="resetChoiceButton"
onclick="flag = null; renderStateData(previousStateString, true);">Reset Choice
</button>

<button type="button" id="finishChoiceButton"
onclick="flag = flag.shortCircuit(flag); renderStateData(previousStateString, true);">Finish Choice
</button>

<div>
	<div id="handdiv" class="hud">
	<p>Hand:</p>
	<div id="hand"></div>
	</div>


	<div id="discarddiv" class="hud">
	<p>Discard:</p>
	<div id="played"></div>
	<br>
	<div id="discard"></div>
	</div>
	<div id="deckdiv" class="hud">
	<p>Deck:</p>
	<div id="deck"></div>
	</div>

	<div id="playerdata" class="hud">
	</div>
</div>

<div>
<h6>Played cards:</h6>
<div id="playedcards"></div>
</div>

<div id="table"></div>

<div id="store"></div>

<div
id="log"
style="height:15em; border-style:solid; overflow-y:scroll;"
>
</div>

<div id="state"
style="height:5em; border-style:solid; overflow:auto;"
>

<script>
document.getElementById("text").onkeypress = function(k){if (k.keyCode==13) sendText();};

window.setInterval(function(){ajax('/log/', null, renderLogData)}, 1000);
window.setInterval(render, 100);
//window.setInterval(function(){poll()}, 1000)
</script>
</body>
</html>
